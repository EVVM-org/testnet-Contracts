#!/bin/bash

# Get the directory where the script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Detect OS and architecture
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)

# Detect if using musl (Alpine Linux, etc.)
IS_MUSL=false
if [[ "$OS" == "linux" ]]; then
  if ldd --version 2>&1 | grep -qi musl; then
    IS_MUSL=true
  fi
fi

# Determine the executable
if [[ "$OS" == "linux" && "$ARCH" == "x86_64" ]]; then
  if [[ "$IS_MUSL" == true ]]; then
    EXECUTABLE="$SCRIPT_DIR/.executables/evvm-linux-x64-musl"
  else
    EXECUTABLE="$SCRIPT_DIR/.executables/evvm-linux-x64"
  fi
elif [[ "$OS" == "linux" && "$ARCH" == "aarch64" ]]; then
  if [[ "$IS_MUSL" == true ]]; then
    EXECUTABLE="$SCRIPT_DIR/.executables/evvm-linux-arm64-musl"
  else
    EXECUTABLE="$SCRIPT_DIR/.executables/evvm-linux-arm64"
  fi
elif [[ "$OS" == "darwin" && "$ARCH" == "x86_64" ]]; then
  EXECUTABLE="$SCRIPT_DIR/.executables/evvm-darwin-x64"
elif [[ "$OS" == "darwin" && "$ARCH" == "arm64" ]]; then
  EXECUTABLE="$SCRIPT_DIR/.executables/evvm-darwin-arm64"
elif [[ "$OS" == "cygwin" || "$OS" == "mingw"* || "$OS" == "msys"* ]]; then
  EXECUTABLE="$SCRIPT_DIR/.executables/evvm-windows-x64.exe"
else
  echo "Unsupported platform or architecture: $OS-$ARCH"
  exit 1
fi

# Execute the binary
if [[ -x "$EXECUTABLE" ]]; then
  # run and capture exit status so we can handle common failure cases
  "$EXECUTABLE" "$@"
  status=$?
  if [[ $status -ne 0 ]]; then
    # exit code 126 means the kernel refused to execute the file (wrong format/arch)
    if [[ $status -eq 126 ]]; then
      echo "Warning: native CLI binary failed to execute (exit code 126)."
      echo "This usually means the file in .executables/ is not built for your platform."
      # try a fallback to Bun if available
      if command -v bun >/dev/null 2>&1; then
        echo "Attempting to run the CLI via Bun fallback..."
        bun run cli/index.ts "$@"
        exit $?
      else
        echo "bun is not installed. Install Bun or rebuild the binaries on the correct OS." >&2
      fi
    fi
    exit $status
  fi
else
  echo "Executable not found or not executable: $EXECUTABLE"
  echo "Please ensure the executable exists and has execute permissions."
  echo "Try: chmod +x $EXECUTABLE"
  exit 1
fi